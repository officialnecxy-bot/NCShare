<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NCX Drop | Ultra</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --bg: #050505;
            --primary: #ff1f1f;
            --primary-glow: rgba(255, 31, 31, 0.4);
            --glass-panel: rgba(20, 20, 20, 0.7);
            --glass-border: 1px solid rgba(255, 255, 255, 0.08);
            --glass-light: rgba(255, 255, 255, 0.05);
            --text: #ffffff;
            --text-muted: #888;
            --radius: 24px;
            --blur: blur(40px);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg); color: var(--text);
            height: 100vh; display: flex; justify-content: center; align-items: center;
            overflow: hidden;
            background-image: 
                radial-gradient(circle at 10% 10%, rgba(255, 31, 31, 0.15), transparent 40%),
                radial-gradient(circle at 90% 90%, rgba(255, 31, 31, 0.1), transparent 40%);
        }

        /* --- LAYOUT --- */
        #app {
            width: 95%; max-width: 1000px; height: 90vh;
            background: var(--glass-panel);
            backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur);
            border: var(--glass-border); border-radius: var(--radius);
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
            display: flex; overflow: hidden;
        }

        /* --- SIDEBAR --- */
        aside {
            width: 80px; border-right: var(--glass-border);
            display: flex; flex-direction: column; align-items: center; padding: 30px 0;
            z-index: 20; background: rgba(0,0,0,0.2);
        }
        
        .logo-icon { 
            width: 50px; height: 50px; background: var(--primary); border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; font-size: 1.5rem; 
            box-shadow: 0 0 20px var(--primary-glow); margin-bottom: 40px; color: white;
        }

        .nav-btn {
            width: 50px; height: 50px; border-radius: 16px; color: var(--text-muted);
            display: flex; align-items: center; justify-content: center; font-size: 1.4rem;
            margin-bottom: 15px; cursor: pointer; transition: 0.3s;
        }
        .nav-btn:hover { background: var(--glass-light); color: white; }
        .nav-btn.active { background: var(--primary); color: white; box-shadow: 0 5px 15px var(--primary-glow); }

        /* --- MAIN AREA --- */
        main { flex: 1; position: relative; overflow: hidden; display: flex; flex-direction: column; }

        header {
            padding: 20px 30px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: var(--glass-border);
        }
        .page-title { font-size: 1.5rem; font-weight: 700; }
        .connection-status { 
            padding: 8px 16px; border-radius: 30px; background: var(--glass-light); 
            border: var(--glass-border); font-size: 0.9rem; display: flex; align-items: center; gap: 8px;
        }
        .status-dot { width: 8px; height: 8px; background: #666; border-radius: 50%; transition: 0.3s; }
        .status-dot.online { background: #00ff88; box-shadow: 0 0 10px #00ff88; }

        /* --- VIEWS --- */
        .view { position: absolute; inset: 0; top: 80px; padding: 30px; overflow-y: auto; opacity: 0; pointer-events: none; transition: 0.3s; transform: translateY(10px); }
        .view.active { opacity: 1; pointer-events: all; transform: translateY(0); }

        /* Home View */
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; height: 100%; }
        
        .card {
            background: var(--glass-light); border: var(--glass-border); border-radius: 20px;
            padding: 25px; position: relative; display: flex; flex-direction: column;
        }
        
        .id-box {
            font-family: monospace; font-size: 1.4rem; color: var(--primary); letter-spacing: 2px;
            background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px; text-align: center;
            margin: 15px 0; border: 1px dashed var(--primary); cursor: pointer;
        }
        .id-box:hover { background: rgba(255, 31, 31, 0.1); }

        .drop-zone {
            flex: 1; border: 2px dashed rgba(255,255,255,0.2); border-radius: 20px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: 0.3s; cursor: pointer; background: rgba(0,0,0,0.2);
        }
        .drop-zone:hover { border-color: var(--primary); background: rgba(255, 31, 31, 0.05); }
        .drop-icon { font-size: 3.5rem; color: var(--text-muted); margin-bottom: 15px; transition: 0.3s; }
        .drop-zone:hover .drop-icon { color: var(--primary); transform: translateY(-5px); }

        /* Chat View */
        .chat-container { display: flex; flex-direction: column; height: 100%; }
        .chat-messages { flex: 1; overflow-y: auto; padding-right: 10px; display: flex; flex-direction: column; gap: 10px; }
        .chat-input-area { margin-top: 20px; display: flex; gap: 10px; }
        
        .msg { padding: 12px 18px; border-radius: 18px; max-width: 80%; font-size: 0.95rem; line-height: 1.4; }
        .msg.me { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .msg.other { align-self: flex-start; background: var(--glass-light); border: var(--glass-border); border-bottom-left-radius: 2px; }

        input {
            width: 100%; background: rgba(0,0,0,0.3); border: var(--glass-border);
            padding: 15px; border-radius: 15px; color: white; font-family: inherit;
        }
        input:focus { border-color: var(--primary); }

        /* Connect View */
        .qr-container { background: white; padding: 15px; border-radius: 15px; width: fit-content; margin: 0 auto; }

        /* Buttons */
        .btn {
            border: none; padding: 12px 20px; border-radius: 50px; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s;
        }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 5px 15px var(--primary-glow); }
        .btn-primary:active { transform: scale(0.95); }
        .btn-glass { background: var(--glass-light); color: white; border: var(--glass-border); }

        /* Transfer List */
        .transfer-item {
            display: flex; align-items: center; gap: 15px; padding: 15px;
            background: var(--glass-light); border-radius: 15px; margin-bottom: 10px;
        }
        .file-icon { font-size: 1.5rem; color: var(--primary); }
        .progress-bar { height: 4px; background: #333; border-radius: 2px; margin-top: 5px; width: 100%; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: 0.2s; }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            #app { width: 100%; height: 100%; border-radius: 0; border: none; flex-direction: column-reverse; }
            aside { width: 100%; height: 70px; flex-direction: row; justify-content: space-around; padding: 0; border-right: none; border-top: var(--glass-border); background: #000; }
            .logo-icon { display: none; }
            .nav-btn { margin-bottom: 0; }
            .dashboard-grid { grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
            .view { padding: 20px; }
        }

    </style>
</head>
<body>

<div id="app">
    <aside>
        <div class="logo-icon"><i class="fa-solid fa-bolt"></i></div>
        <div class="nav-btn active" onclick="ui.view('home', this)"><i class="fa-solid fa-house"></i></div>
        <div class="nav-btn" onclick="ui.view('connect', this)"><i class="fa-solid fa-link"></i></div>
        <div class="nav-btn" onclick="ui.view('chat', this)"><i class="fa-solid fa-comment-dots"></i></div>
        <div class="nav-btn" onclick="ui.view('settings', this)"><i class="fa-solid fa-gear"></i></div>
    </aside>

    <main>
        <header>
            <div class="page-title">NCX Drop</div>
            <div class="connection-status">
                <div class="status-dot" id="status-dot"></div>
                <span id="status-text">Disconnected</span>
            </div>
        </header>

        <div id="view-home" class="view active">
            <div class="dashboard-grid">
                <div class="card drop-zone" onclick="document.getElementById('file-in').click()" id="drop-area">
                    <i class="fa-solid fa-cloud-arrow-up drop-icon"></i>
                    <h3>Send Files</h3>
                    <p style="color:#888; font-size:0.9rem;">Click or Drag files here</p>
                    <input type="file" id="file-in" style="display:none" multiple onchange="core.sendFiles(this.files)">
                </div>

                <div class="card" style="justify-content: flex-start;">
                    <h4 style="margin-bottom:15px;">Transfer Activity</h4>
                    <div id="transfer-list" style="overflow-y: auto; flex:1;">
                        <div style="text-align:center; color:#666; margin-top:20px;">No activity yet.</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-connect" class="view">
            <div class="card" style="text-align: center; max-width: 500px; margin: 0 auto;">
                <h3>Your Identity</h3>
                <p style="color:#888; margin-bottom: 20px;">Share this ID or scan QR to pair devices.</p>
                
                <div class="id-box" id="my-id" onclick="core.copyId()">Loading...</div>
                
                <div id="qrcode" class="qr-container"></div>
                
                <div style="width:100%; height:1px; background:rgba(255,255,255,0.1); margin: 25px 0;"></div>
                
                <h3>Connect to Peer</h3>
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <input type="text" id="remote-id" placeholder="Enter Friend's ID">
                    <button class="btn-primary" onclick="core.connect()"><i class="fa-solid fa-plug"></i></button>
                </div>
            </div>
        </div>

        <div id="view-chat" class="view">
            <div class="card chat-container">
                <div id="chat-box" class="chat-messages">
                    <div style="text-align:center; color:#666; margin-top:auto;">Start chatting securely.</div>
                </div>
                <div class="chat-input-area">
                    <input type="text" id="chat-in" placeholder="Type a message..." onkeypress="if(event.key==='Enter') core.sendChat()">
                    <button class="btn-primary" style="width:50px; border-radius:15px;" onclick="core.sendChat()"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

        <div id="view-settings" class="view">
            <div class="card">
                <h3>Settings</h3>
                <div style="margin-top:20px;">
                    <div style="display:flex; justify-content:space-between; padding:15px; border-bottom:1px solid rgba(255,255,255,0.05);">
                        <span>Auto-Download Files</span>
                        <input type="checkbox" checked style="width:20px;">
                    </div>
                    <div style="display:flex; justify-content:space-between; padding:15px; border-bottom:1px solid rgba(255,255,255,0.05);">
                        <span>Play Sound on Receive</span>
                        <input type="checkbox" checked style="width:20px;">
                    </div>
                    <div style="padding:15px;">
                        <button class="btn-glass" style="width:100%; color:#ff4444; border-color:rgba(255,0,0,0.2);" onclick="location.reload()">Reset Connection</button>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
    // --- APP CORE ---
    let peer, conn;
    let autoDownload = true;

    // --- UI CONTROLLER ---
    const ui = {
        view: (id, el) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('view-'+id).classList.add('active');
            if(el) {
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                el.classList.add('active');
            }
            if(id === 'chat') {
                const box = document.getElementById('chat-box');
                box.scrollTop = box.scrollHeight;
            }
        },
        status: (connected, name) => {
            const dot = document.getElementById('status-dot');
            const txt = document.getElementById('status-text');
            if(connected) {
                dot.classList.add('online');
                txt.innerText = "Connected to " + name;
                txt.style.color = "#00ff88";
            } else {
                dot.classList.remove('online');
                txt.innerText = "Disconnected";
                txt.style.color = "#888";
            }
        },
        logTransfer: (name, size, type) => {
            const list = document.getElementById('transfer-list');
            if(list.innerText.includes('No activity')) list.innerHTML = '';
            
            const html = `
                <div class="transfer-item">
                    <div class="file-icon"><i class="fa-solid ${type==='sent'?'fa-arrow-up':'fa-arrow-down'}"></i></div>
                    <div style="flex:1">
                        <div style="font-weight:600; font-size:0.9rem;">${name}</div>
                        <div style="font-size:0.8rem; color:#888;">${core.formatSize(size)} • ${type==='sent'?'Sent':'Received'}</div>
                        <div class="progress-bar"><div class="progress-fill" style="width:100%"></div></div>
                    </div>
                </div>`;
            list.innerHTML = html + list.innerHTML;
        },
        msg: (txt, type) => {
            const box = document.getElementById('chat-box');
            if(box.innerText.includes('Start chatting')) box.innerHTML = '';
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerText = txt;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }
    };

    // --- P2P LOGIC ---
    const core = {
        init: () => {
            // Generate Short ID
            const myId = 'ncx-' + Math.floor(Math.random()*90000 + 10000);
            peer = new Peer(myId);

            peer.on('open', (id) => {
                document.getElementById('my-id').innerText = id;
                // Generate QR
                new QRCode(document.getElementById("qrcode"), {
                    text: window.location.href + "?connect=" + id,
                    width: 128, height: 128,
                    colorDark : "#000000", colorLight : "#ffffff"
                });
                
                // URL Auto Connect
                const urlParams = new URLSearchParams(window.location.search);
                if(urlParams.get('connect')) {
                    document.getElementById('remote-id').value = urlParams.get('connect');
                    ui.view('connect');
                    setTimeout(core.connect, 1000);
                }
            });

            peer.on('connection', (c) => {
                conn = c;
                core.setupConn();
            });
        },

        connect: () => {
            const id = document.getElementById('remote-id').value;
            if(!id) return alert("Enter ID");
            conn = peer.connect(id);
            core.setupConn();
        },

        setupConn: () => {
            conn.on('open', () => {
                ui.status(true, conn.peer);
                ui.view('home');
                
                // Send handshake chat
                conn.send({type: 'chat', msg: '⚡ Connection Established!'});
                ui.msg('⚡ Connection Established!', 'other');
            });

            conn.on('data', (data) => {
                if(data.type === 'chat') {
                    ui.msg(data.msg, 'other');
                    // Badge notification logic could go here
                } 
                else if(data.type === 'file') {
                    // Receive File
                    ui.logTransfer(data.name, data.file.byteLength, 'received');
                    if(autoDownload) {
                        const blob = new Blob([data.file]);
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = data.name;
                        a.click();
                    }
                }
            });

            conn.on('close', () => ui.status(false));
        },

        sendChat: () => {
            const inp = document.getElementById('chat-in');
            const txt = inp.value;
            if(!txt || !conn) return;
            conn.send({type: 'chat', msg: txt});
            ui.msg(txt, 'me');
            inp.value = '';
        },

        sendFiles: (files) => {
            if(!conn) return alert("Not Connected!");
            Array.from(files).forEach(f => {
                ui.logTransfer(f.name, f.size, 'sent');
                // Sending whole blob (PeerJS handles binary)
                // For large files >10MB in production, chunking is needed.
                // This fits the "Single File Simple App" constraint.
                const blob = new Blob([f], {type: f.type});
                conn.send({type: 'file', file: blob, name: f.name});
            });
        },

        copyId: () => {
            navigator.clipboard.writeText(document.getElementById('my-id').innerText);
            alert("ID Copied!");
        },

        formatSize: (bytes) => {
            if(bytes===0) return '0 B';
            const k=1024, sizes=['B','KB','MB','GB'];
            const i=Math.floor(Math.log(bytes)/Math.log(k));
            return parseFloat((bytes/Math.pow(k,i)).toFixed(2))+' '+sizes[i];
        }
    };

    // --- DRAG & DROP ---
    const dropArea = document.getElementById('drop-area');
    dropArea.addEventListener('dragover', (e) => { e.preventDefault(); dropArea.style.borderColor = 'var(--primary)'; });
    dropArea.addEventListener('dragleave', () => { dropArea.style.borderColor = 'rgba(255,255,255,0.2)'; });
    dropArea.addEventListener('drop', (e) => {
        e.preventDefault();
        dropArea.style.borderColor = 'rgba(255,255,255,0.2)';
        core.sendFiles(e.dataTransfer.files);
    });

    // START
    core.init();

</script>
</body>
</html>
